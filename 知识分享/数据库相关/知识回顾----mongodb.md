[toc]

# 使用场景

当项目涉及到以下场景，可以考虑采用mongodb。

（1）对象的数据结构不能确定，需要快速迭代。（关系型数据库修改数据结构成本过高）

（2）预估后续数据量会快速增长。（关系型数据库扩容操作很麻烦）

# 核心相关概念

## json文档

不同于关系型数据库以行数据为数据最小单元，mongodb是使用json文档来进行数据存储。使用json文档存储数据有以下优点：

（1）数据结构灵活，支持同一集合之间文档字段不同、结构不同。

（2）可读性好。json表示对象一目了然。

（3）支持数组、内嵌这种数据结构。数据模型搭建快速。

## 分片集群

mongodb进行快速扩容主要通过两个操作进行

(1)主从架构。可以建立多个从节点提升读性能，主从架构保证项目高可用。

(2)分片集群。可以按照键进行分片（类似于mysql的分表），而且天然支持将不同的分片数据聚合（这个性能很低，业务查询肯定不可以）

## 查询优化

### 查询流程（假设查询某一分片数据）

（1）客户端通过mongos选择节点执行查询请求。（这里可以通过增加节点、合理负载均衡提高系统的读性能）

（2）服务节点判断请求是否可以匹配计划缓存。（计划缓存是存在内存中，mongodb会把各种各样的数据集、缓存放入内存，所以内存配置一定要大）

（3）匹配计划缓存成功则直接执行。

（4）匹配失败，先进行计划分析，之后运行多个线程去跑不同的执行计划，选取其中性能最好的计划执行并加入计划缓存。

### 索引机制

（1）b树结构

mongodb数据的底层存储也是采取b树结构，并且也有一个全局的自增id。文档数据根据id顺序排序存储，索引数据根据索引字段排序存储。所以和mysql一样，如果使用覆盖索引、最左前缀匹配可以大幅提升性能。

（2）多样的索引类型

1，mongodb支持对部分文档建立索引。

2，mongodb支持全文索引、地理位置索引。



# 快速入门（建议自行参考mongodb官方文档）

## 增删查改

命令行可以搜索MQL

java代码接入可以搜索MongoTemplate

## 聚合查询（进行简单的数据统计分析）

参照官方文档aggregate用法

# mongodb易错问题总结

## 1.mongodb不需要进行模型设计，所有对象放入一个集合里即可？

结论：错误，mongodb也需要进行模型设计。

mongodb模型设计需要遵循以下几点

（1）一个集合只存放一类实体对象。（如果需要快速迭代建议增加version字段，方便后续数据处理）

（2）通过数组、嵌套构建json文档，最好不要存在关联关系。

## 2.mongodb数据较多，如何优化性能？

从架构层面：

（1）将数据进行分片提升读写性能。

（2）设置多一些的从节点进行提高读取性能（注意增加从节点不会提升写性能，并且会增加数据同步成本）。

从业务开发层面：

（1）必须为所有的高频查询建立索引。

（2）尽可能利用覆盖索引避免扫描数据文档。


从硬件层面

（1）mongodb分配内存一定要大于常用索引数据。

（2）使用ssd。

## 3.mongodb容易丢数据，不适用于重要数据的存储？

结论：是误解，mongodb不会丢数据。

（1）mongodb拥有持久化机制，不会丢数据。

（2）我们以为的丢数据，可能是因为主从延时，或者执行写操作的节点还未同步数据突然宕机导致。可以指定写入、读取操作均为majority，只有大部分数据节点数据同步后才算写入读取操作完成。

## 4.mongodb不支持事务？

mongodb支持事务，并且从4.2开始支持多文档事务。但是mongodb的事务机制并没有被主流使用，建议观望。

## 5.mongodb不支持关联统计等等操作？

mongodb支持类似于mysql这种关联统计的操作，具体可见mongodb的聚合查询（aggregate用法）。

## 6.既然mongodb这么好，直接替换mysql？

这里要根据业务场景来看，如果业务稳定，数据量，并发量均不高，并且某些业务需要事务机制保证，使用mysql即可。mongodb主要在数据结构的快速迭代、大数据量查询下更加有优势。


**参考资料**

（1）mongodb中文文档
（2）极客时间的《mongodb高手课》课程

